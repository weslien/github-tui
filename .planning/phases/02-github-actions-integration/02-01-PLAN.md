---
phase: 02-github-actions-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - domain/workflow_run.go
  - domain/workflow_job.go
  - github/actions.go
  - github/actions_test.go
autonomous: true

must_haves:
  truths:
    - "WorkflowRun domain type implements Item interface with status-colored fields"
    - "WorkflowJob domain type implements Item interface with status-colored fields"
    - "API functions wrap go-github ActionsService methods with proper error wrapping"
    - "Log download strips ANSI escape codes and GitHub timestamp prefixes"
    - "Log download caps size at 10MB to prevent OOM"
  artifacts:
    - path: "domain/workflow_run.go"
      provides: "WorkflowRun struct implementing domain.Item"
      contains: "func (w *WorkflowRun) Fields()"
    - path: "domain/workflow_job.go"
      provides: "WorkflowJob struct implementing domain.Item"
      contains: "func (j *WorkflowJob) Fields()"
    - path: "github/actions.go"
      provides: "Actions API functions and ANSI/timestamp stripping"
      exports: ["ListWorkflowRuns", "ListWorkflows", "ListWorkflowJobs", "GetWorkflowJobLog", "ConvertWorkflowRun", "ConvertWorkflowJob"]
    - path: "github/actions_test.go"
      provides: "Tests for domain type conversion and log cleaning"
      contains: "func Test"
  key_links:
    - from: "github/actions.go"
      to: "github/client.go"
      via: "GetRESTClient()"
      pattern: "GetRESTClient\\(\\)"
    - from: "github/actions.go"
      to: "domain/workflow_run.go"
      via: "ConvertWorkflowRun returns domain.WorkflowRun"
      pattern: "domain\\.WorkflowRun"
    - from: "domain/workflow_run.go"
      to: "domain/item.go"
      via: "implements Item interface"
      pattern: "func \\(w \\*WorkflowRun\\) Key\\(\\)"
---

<objective>
Create domain types (WorkflowRun, WorkflowJob) implementing the Item interface, API layer functions wrapping go-github ActionsService, and log cleaning utilities using TDD.

Purpose: These types and functions form the data foundation that all Actions UI components depend on. TDD ensures the domain conversion logic, status-to-color mapping, and ANSI stripping are correct before any UI integration.

Output: Tested domain types, API wrapper functions, and log cleaning utilities.
</objective>

<execution_context>
@/Users/gustav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gustav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-dual-client-setup/01-01-SUMMARY.md

Key codebase files to reference:
@domain/item.go — Item interface (Key() string, Fields() []Field)
@domain/issue.go — Example Item implementation (pattern to follow)
@github/client.go — GetRESTClient() accessor, gogithub import alias
@github/query.go — PageInfo type (EndCursor, HasNextPage)
</context>

<feature>
  <name>Actions Domain Types and API Layer</name>
  <files>
    domain/workflow_run.go
    domain/workflow_job.go
    github/actions.go
    github/actions_test.go
  </files>
  <behavior>
    1. WorkflowRun.Key() returns string ID
    2. WorkflowRun.Fields() returns [status, workflow_name, branch, event, duration] with status-dependent colors:
       - status="completed", conclusion="success" -> green
       - status="completed", conclusion="failure" -> red
       - status="completed", conclusion="cancelled" -> gray
       - status="in_progress" -> yellow
       - status="queued" or "waiting" -> gray
       - For completed runs, display conclusion text; for non-completed, display status text
    3. WorkflowJob.Key() returns string ID
    4. WorkflowJob.Fields() returns [status, name, duration] with same color logic
    5. ConvertWorkflowRun converts *gogithub.WorkflowRun to *domain.WorkflowRun:
       - ID from GetID()
       - Name from GetName()
       - Title from GetDisplayTitle()
       - Status from GetStatus(), Conclusion from GetConclusion()
       - HeadBranch from GetHeadBranch(), Event from GetEvent()
       - RunNumber from GetRunNumber()
       - Duration computed from RunStartedAt to UpdatedAt (formatted as "Xs", "Xm Ys", "Xh Ym")
       - CreatedAt formatted as "15:04" for today, "Jan 02 15:04" for other days
       - HTMLURL from GetHTMLURL()
    6. ConvertWorkflowJob converts *gogithub.WorkflowJob to *domain.WorkflowJob
    7. CleanLog(raw string) string:
       - Strips ANSI escape sequences: regex `\x1b\[[0-9;]*[a-zA-Z]`
       - Strips GitHub timestamp prefixes: regex `(?m)^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z `
       - Returns cleaned plain text
    8. ListWorkflowRuns wraps client.Actions.ListRepositoryWorkflowRuns
    9. ListWorkflows wraps client.Actions.ListWorkflows with full pagination
    10. ListWorkflowJobs wraps client.Actions.ListWorkflowJobs
    11. GetWorkflowJobLog fetches log URL then downloads content with 10MB cap via io.LimitReader

    Test cases (table-driven):
    - CleanLog: input with ANSI codes -> stripped output
    - CleanLog: input with timestamps -> stripped output
    - CleanLog: input with both ANSI + timestamps -> fully cleaned
    - CleanLog: input with no special chars -> unchanged
    - ConvertWorkflowRun: completed/success run -> correct fields and green status
    - ConvertWorkflowRun: in_progress run -> yellow status, status text "in_progress"
    - ConvertWorkflowRun: completed/failure -> red status, conclusion text "failure"
    - ConvertWorkflowRun: nil RunStartedAt -> empty duration
    - WorkflowRun.Fields() color mapping for all status/conclusion combinations
    - WorkflowJob.Fields() color mapping
    - formatDuration: <60s, minutes, hours
  </behavior>
  <implementation>
    domain/workflow_run.go:
    - WorkflowRun struct with fields: ID (int64), Name, Title, Status, Conclusion, HeadBranch, Event string, RunNumber int, CreatedAt, Duration, HTMLURL string, RunID int64
    - Key() returns fmt.Sprintf("%d", w.ID)
    - Fields() returns 5 Field values with statusToColor() helper
    - statusToColor(status, conclusion string) tcell.Color helper (unexported, shared between run and job)

    domain/workflow_job.go:
    - WorkflowJob struct with fields: ID (int64), Name, Status, Conclusion, Duration, HTMLURL string, RunID int64
    - Key() returns fmt.Sprintf("%d", j.ID)
    - Fields() returns 3 Field values [status, name, duration]

    github/actions.go:
    - Import gogithub alias (established pattern from Phase 1)
    - var ansiRegex, timestampRegex compiled regexes
    - CleanLog(raw string) string — strips ANSI + timestamps
    - ConvertWorkflowRun(*gogithub.WorkflowRun) *domain.WorkflowRun
    - ConvertWorkflowJob(*gogithub.WorkflowJob) *domain.WorkflowJob
    - formatDuration(d time.Duration) string
    - formatTime(t time.Time) string
    - ListWorkflowRuns, ListWorkflows, ListWorkflowJobs, GetWorkflowJobLog
    - ListWorkflowRunsByWorkflowID for workflow-specific filtering

    github/actions_test.go:
    - Table-driven tests for CleanLog, ConvertWorkflowRun, ConvertWorkflowJob, formatDuration
    - Use gogithub.Timestamp for time fields in test data
    - Do NOT test API functions (they need real client); only test pure conversion/cleaning logic
  </implementation>
</feature>

<verification>
```bash
go test -race -v ./github/ -run TestCleanLog
go test -race -v ./github/ -run TestConvertWorkflow
go test -race -v ./github/ -run TestFormatDuration
go build ./...
```
</verification>

<success_criteria>
- All tests pass with -race flag
- `go build ./...` succeeds
- WorkflowRun and WorkflowJob implement domain.Item (compiler-verified)
- CleanLog handles ANSI codes, timestamps, and combined input correctly
- ConvertWorkflowRun maps all go-github fields to domain fields
- Duration formatting handles seconds, minutes, and hours
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-actions-integration/02-01-SUMMARY.md`
</output>
