---
phase: 02-github-actions-integration
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - ui/actions.go
autonomous: true

must_haves:
  truths:
    - "User can select a workflow run and see its jobs listed"
    - "User can view logs for a specific job with ANSI codes and timestamps stripped"
    - "Log download is capped at 10MB with truncation message"
    - "User can navigate back from jobs to runs and from logs to jobs"
  artifacts:
    - path: "ui/actions.go"
      provides: "Jobs list drill-down and log viewing within Actions tab"
      contains: "WorkflowJobsUI"
  key_links:
    - from: "ui/actions.go"
      to: "github/actions.go"
      via: "ListWorkflowJobs for job listing, GetWorkflowJobLog for log content"
      pattern: "github\\.ListWorkflowJobs|github\\.GetWorkflowJobLog"
    - from: "ui/actions.go"
      to: "domain/workflow_job.go"
      via: "ConvertWorkflowJob for Item interface display"
      pattern: "github\\.ConvertWorkflowJob"
---

<objective>
Add jobs drill-down and log viewing to the Actions tab. When a user selects a workflow run and presses Enter, they see the jobs for that run. When they select a job and press Enter, the job's log is displayed in a full-screen text viewer with ANSI codes stripped.

Purpose: This completes the Actions monitoring workflow (ACT-04: view jobs, ACT-05: view logs). Users can now drill from runs -> jobs -> logs, which is the core workflow for debugging CI failures.

Output: Complete runs -> jobs -> logs navigation within the Actions tab.
</objective>

<execution_context>
@/Users/gustav/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gustav/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-github-actions-integration/02-01-SUMMARY.md
@.planning/phases/02-github-actions-integration/02-02-SUMMARY.md

Key codebase files to reference:
@ui/actions.go — Actions tab with WorkflowRunsUI (created in Plan 02)
@ui/view.go — ViewUI pattern for text display, search (/), navigation (n/N), fullscreen (o)
@ui/ui.go — FullScreenPreview pattern, Modal pattern, updater channel
@ui/select.go — SelectUI.GetSelect() to get selected item, SetSelectionChangedFunc
@github/actions.go — ListWorkflowJobs, GetWorkflowJobLog, ConvertWorkflowJob, CleanLog
@domain/workflow_run.go — WorkflowRun.RunID for job fetching
@domain/workflow_job.go — WorkflowJob.ID for log fetching, WorkflowJob.HTMLURL for browser
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jobs list drill-down from workflow runs</name>
  <files>ui/actions.go</files>
  <action>
Add a jobs list that appears when the user selects a workflow run:

1. **Add WorkflowJobsUI variable:**
   - `var WorkflowJobsUI *SelectUI` — jobs table for the selected run
   - `var currentRunID int64` — tracks which run's jobs are displayed

2. **Create jobs SelectUI in NewActionsUI:**
   - Create a second SelectUI for jobs: `NewSelectListUI(UIKind("jobs"), tcell.ColorYellow, jobOpt)` where `jobOpt` sets:
     - `ui.header`: `["", "Status", "Job", "Duration"]`
     - `ui.hasHeader = true`
     - `ui.getList`: fetches jobs for `currentRunID` using `github.ListWorkflowJobs`, converts via `github.ConvertWorkflowJob`
       - Jobs are not paginated (GitHub returns all jobs for a run in one response, typically <20 jobs), so return PageInfo with HasNextPage=false
     - `ui.capture`: keybinding handler:
       - `tcell.KeyEscape`: go back to workflow runs view (hide jobs, show runs, refocus WorkflowRunsUI)
       - `tcell.KeyCtrlO`: open selected job's HTMLURL in browser via utils.Open
       - `tcell.KeyEnter`: fetch and display log for selected job (see Task 2)

3. **Drill-down from runs to jobs (Enter key on WorkflowRunsUI):**
   - In WorkflowRunsUI's capture handler, add `tcell.KeyEnter` case:
     - Get selected item: `WorkflowRunsUI.GetSelect().(*domain.WorkflowRun)`
     - Set `currentRunID = run.RunID`
     - Show jobs view: swap the visible component in the Actions grid
     - Approach: Use a tview.Pages within the Actions grid to switch between "runs" and "jobs" sub-views. This keeps the Actions page structure clean.
       - Alternative approach (simpler): Use visibility toggling by replacing the grid item. Since tview.Grid doesn't support removing items easily, prefer using an inner `tview.Pages` named `actionsPages` that has "runs-view" (WorkflowRunsUI) and "jobs-view" (a grid with WorkflowJobsUI + a header showing run info).
     - After switching to jobs view, call `WorkflowJobsUI.GetList()` to fetch jobs
     - Update status line to show: "Run: #123 - workflow_name | Esc: back"

4. **Back navigation (Escape from jobs):**
   - When Escape is pressed in jobs view, switch `actionsPages` back to "runs-view"
   - Refocus WorkflowRunsUI
   - Restore status line to filter display

5. **Modify the grid layout in NewActionsUI:**
   - Change from directly embedding WorkflowRunsUI to using `actionsPages`:
     ```go
     actionsPages := tview.NewPages().
         AddAndSwitchToPage("runs-view", WorkflowRunsUI, true).
         AddPage("jobs-view", jobsGrid, true, false)

     grid := tview.NewGrid().SetRows(1, 0).
         AddItem(statusLine, 0, 0, 1, 1, 0, 0, false).
         AddItem(actionsPages, 1, 0, 1, 1, 0, 0, true)
     ```
   - `jobsGrid` contains a header text showing the run info and WorkflowJobsUI below it

  </action>
  <verify>
```bash
go build ./...
```
Verify:
- WorkflowJobsUI exists as a SelectUI
- Enter on a run triggers job fetching
- Escape from jobs returns to runs
- Jobs display with status, name, duration columns
  </verify>
  <done>
User can press Enter on a workflow run to see its jobs listed. Jobs show status (colored), job name, and duration. User can press Escape to return to the runs list. The status bar updates to show which run is selected. User can open a job in browser via Ctrl+O.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add job log viewing with ANSI stripping</name>
  <files>ui/actions.go</files>
  <action>
Add log viewing when user selects a job:

1. **Enter key on WorkflowJobsUI:**
   - In WorkflowJobsUI's capture handler for `tcell.KeyEnter`:
     - Get selected job: `WorkflowJobsUI.GetSelect().(*domain.WorkflowJob)`
     - Show a "Loading log..." message in a temporary TextView or update the status line
     - In a goroutine, call `github.GetWorkflowJobLog(ctx, owner, repo, job.ID, 10*1024*1024)` (10MB limit)
     - Use `context.WithTimeout` of 30 seconds for the download
     - On success, clean the log via `github.CleanLog(rawLog)`
     - Display using `UI.FullScreenPreview(cleanedLog, focusFunc)` where focusFunc refocuses WorkflowJobsUI
     - The FullScreenPreview already supports:
       - '/' for search within logs
       - 'n'/'N' for next/prev search match
       - 'o' to close fullscreen and return (established in ViewUI)
     - If download fails, show error via `UI.Message(err.Error(), focusFunc)`
     - If log was truncated (content length == 10MB), append at the end:
       ```
       \n--- Log truncated at 10MB. Press Ctrl+O on the job to view full log in browser. ---
       ```

2. **Loading indicator:**
   - Before starting the goroutine, update the status line text to "Loading log for: {job.Name}..."
   - After log is loaded and displayed, status line can remain showing the job info
   - Use the existing `UI.updater` channel for UI updates from the goroutine

3. **Context cancellation:**
   - Store a `context.CancelFunc` for the current log download
   - If user presses Escape before log loads, cancel the context and return to jobs view
   - If user presses Enter on a different job while one is loading, cancel the previous download

4. **Error handling:**
   - 404 from GetWorkflowJobLogs: "Log not available. The job may still be running or logs may have expired."
   - Timeout: "Log download timed out. The log may be very large. Press Ctrl+O to view in browser."
   - Other errors: Show the error message via UI.Message

  </action>
  <verify>
```bash
go build ./...
go vet ./...
```
Verify:
- Enter on a job triggers log download
- CleanLog is called on downloaded content
- FullScreenPreview is used for display
- 10MB limit is applied via io.LimitReader
- Truncation message is appended when applicable
- Context timeout is set for download
  </verify>
  <done>
User can press Enter on a job to view its log in full-screen mode. Log content has ANSI escape codes and timestamps stripped. Large logs are truncated at 10MB with a message directing the user to the browser. The full-screen log viewer supports search (/) and navigation (n/N). Pressing 'o' returns to the jobs list. Errors during log download show a clear message.
  </done>
</task>

</tasks>

<verification>
```bash
go build ./...
go vet ./...
```
Manual verification (when running the app):
1. From Actions tab (Ctrl+A), select a workflow run
2. Press Enter to see jobs list
3. Jobs show status, name, duration
4. Press Enter on a job to see log
5. Log is clean (no ANSI codes, no timestamp prefixes)
6. Press 'o' to close log, returns to jobs
7. Press Escape from jobs, returns to runs
8. Full navigation path: Issues -> (Ctrl+A) -> Runs -> (Enter) -> Jobs -> (Enter) -> Log -> (o) -> Jobs -> (Esc) -> Runs -> (Ctrl+I) -> Issues
</verification>

<success_criteria>
- `go build ./...` and `go vet ./...` pass
- Complete drill-down navigation: runs -> jobs -> logs -> back
- Job logs display as clean plain text without ANSI codes or timestamps
- Large logs are capped at 10MB with truncation message
- Log viewer supports search within log content
- Escape navigation works at every level
- Ctrl+O opens job/run in browser from any sub-view
</success_criteria>

<output>
After completion, create `.planning/phases/02-github-actions-integration/02-03-SUMMARY.md`
</output>
